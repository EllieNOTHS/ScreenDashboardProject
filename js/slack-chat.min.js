(function($){varmainOptions={};window.slackChat=false;varmethods={init:function(options){this._defaults={apiToken:'',channelId:'',user:'',userLink:'',userImg:'',userId:'',sysImg:'',sysUser:'',queryInterval:3000,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:'',sendOnEnter:true,disableIfAway:false,elementToDisable:null,heightOffset:75,debug:false,defaultUserImg:'',webCache:false,privateChannel:false,privateChannelId:false,isOpen:false,badgeElement:false,serverApiGateway:"/server/php/server.php"};this._options=$.extend(true,{},this._defaults,options);this._options.queryIntElem=null;this._options.latest=null;if(this._options.debug)console.log('Thisobject:',this);window.slackChat._options=mainOptions=this._options;if(this._options.apiToken=='')methods.validationError('ParameterapiTokenisrequired.');if(this._options.channelId==''&&!this._options.privateChannel)methods.validationError('ParameterchannelIdisrequired.');if(this._options.user=='')methods.validationError('Parameteruserisrequired.');if(this._options.sysUser=='')methods.validationError('ParametersysUserisrequired.');if(this._options.botUser=='')methods.validationError('ParameterbotUserisrequired.');if(typeofmoment=='undefined')methods.validationError('MomentJSisnotavailable.Getitfromhttp:if(this._options.disableIfAway&&this._options.elementToDisable!==null)this._options.elementToDisable.hide();varhtml='<divclass="slackchat slack-chat-box">';html+='<divclass="slack-chat-header">';html+='<buttonclass="close slack-chat-close">&times;</button>';html+=this._options.chatBoxHeader;html+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>";html+='</div>';html+='<divclass="slack-message-box">';html+='</div>';html+='<divclass="send-area">';html+='<textareaclass="form-control slack-new-message"disabled="disabled"type="text"placeholder="Hang tight while we connect..."></textarea>';html+='<divclass="slack-post-message"><iclass="fa fa-fw fa-chevron-right"></i></div>';html+='</div>';html+='</div>';$('body').append(html);var$this=window.slackChat=this;$(this).on('click',function(){if(window.slackChat._options.badgeElement)$(window.slackChat._options.badgeElement).html('').hide();if(window.slackChat._options.privateChannel)window.slackChat._options.isOpen=true;$('.slack-chat-box').show();$('.slack-chat-box').addClass('open');$('.slack-message-box').height($('.slack-chat-box').height()-$('.desc').height()-$('.send-area').height()-parseInt(window.slackChat._options.heightOffset));!functionquerySlackChannel(){if($('.slack-chat-box').hasClass('open')||window.slackChat._options.privateChannel){methods.querySlack($this);setTimeout(querySlackChannel,window.slackChat._options.queryInterval);}}();$('.slackchat.slack-new-message').focus();if(window.slackChat._options.webCache){varscParams={apiToken:window.slackChat._options.apiToken,channelId:window.slackChat._options.channelId,user:window.slackChat._options.user,sysUser:window.slackChat._options.sysUser,botUser:window.slackChat._options.botUser};localStorage.scParams=JSON.stringify(scParams);}});$('.slackchat.slack-chat-close').on('click',function(){$('.slack-chat-box').slideUp();$('.slack-chat-box').removeClass('open');if(!window.slackChat._options.privateChannel)clearInterval(window.slackChat._options.queryIntElem);else{window.slackChat._options.isOpen=false;}});$('.slackchat.slack-post-message').click(function(){methods.postMessage(window.slackChat,window.slackChat._options);});$('.slackchat.slack-new-message').keyup(function(e){if(window.slackChat._options.sendOnEnter){varcode=(e.keyCode?e.keyCode:e.which);if(code==13){methods.postMessage(window.slackChat,window.slackChat._options);e.preventDefault();}}});methods.getUserPresence(window.slackChat,window.slackChat._options);},querySlack:function($elem){options=window.slackChat._options;methods.createChannel($elem,function(channel){window.slackChat._options.channelId=channel.id;$('.slack-new-message').prop('disabled',false).prop('placeholder','Writeamessage...');$.ajax({url:'https:,type:"POST",dataType:'json',data:{token:options.apiToken,channel:mainOptions.channelId,oldest:mainOptions.latest,count:options.messageFetchCount},success:function(resp){if(options.debug&&resp.messages&&resp.messages.length)console.log(resp.messages);if(resp.ok&&resp.messages.length){varhtml='';window.slackChat._options.latest=resp.messages[0].ts;resp.messages=resp.messages.reverse();varrepliesExist=0;for(vari=0;i<resp.messages.length;i++){if(resp.messages[i].subtype=='bot_message'&&resp.messages[i].text!==""){message=resp.messages[i];varuserName='';varuserImg='';varmsgUserId='';if(message.attachments){userName=message.attachments[0].author_name;userImg=message.attachments[0].author_icon;}if(message.fields)msgUserId=message.fields[0].value;varmessageText=methods.formatMessage(message.text.trim());html+="<div class='message-item'>";if(userImg!==''&&typeofuserImg!=='undefined')html+="<div class='userImg'><img src='"+userImg+"' /></div>";elseif(options.defaultUserImg!=='')html+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>";html+="<div class='msgBox'>";if(msgUserId!=='')html+="<div class='username'>"+(msgUserId==options.userId?"You":userName)+"</div>";elsehtml+="<div class='username'>"+userName+"</div>";html+="<div class='message'>"+messageText+"</div>";if(typeofmoment!=='undefined')html+="<div class='timestamp'>"+moment.unix(resp.messages[i].ts).fromNow()+"</div>";html+="</div>";html+="</div>";}elseif(typeofresp.messages[i].subtype=='undefined'){repliesExist++;message=resp.messages[i].text;varuserName=options.sysUser;varmessageText=methods.formatMessage(message);html+="<div class='message-item'>";if(options.sysImg!=='')html+="<div class='userImg'><img src='"+options.sysImg+"' /></div>";html+="<div class='msgBox'>"html+="<div class='username main'>"+userName+"</div>";html+="<div class='message'>"+messageText+"</div>";if(typeofmoment!=='undefined')html+="<div class='timestamp'>"+moment.unix(resp.messages[i].ts).fromNow()+"</div>";html+="</div>";html+="</div>";}}$('.slack-message-box').append(html);$('.slack-message-box').stop().animate({scrollTop:$(".slack-message-box")[0].scrollHeight},800);if(repliesExist>0&&window.slackChat._options.isOpen===false&&window.slackChat._options.badgeElement){$(window.slackChat._options.badgeElement).html(repliesExist).show();}}elseif(!resp.ok){console.log('[SlackChat]Queryfailedwitherrors:');console.log(resp);}}});});},postMessage:function($elem){varoptions=$elem._options;varattachment={};attachment.fallback="View "+options.user+"'s profile";attachment.color=options.slackColor;attachment.author_name=options.user;if(options.userLink!=='')attachment.author_link=options.userLink;if(options.userImg!=='')attachment.author_icon=options.userImg;if(options.userId!=='')attachment.fields=[{"title":"ID","value":options.userId,"short":true}];if($('.slack-new-message').val().trim()==='')returnfalse;message=$('.slack-new-message').val();$('.slack-new-message').val('');if(options.debug){console.log('PostingMessage:');console.log({message:message,attachment:attachment,options:options});}$.ajax({url:'https:,type:"POST",dataType:'json',data:{token:options.apiToken,channel:window.slackChat._options.channelId,text:message,username:options.botUser,attachments:JSON.stringify([attachment])},success:function(resp){if(!resp.ok){$('.slack-new-message').val(message);console.log('[SlackChat]PostMessagefailedwitherrors:');console.log(resp);}}});},validationError:function(errorTxt){$.error('[SlackChatError]'+errorTxt);returnfalse;},getUserPresence:function($elem){varoptions=$elem._options;varactive=false;varuserList=[];$.ajax({url:'https:,type:"POST",dataType:'json',data:{token:options.apiToken},success:function(resp){if(resp.ok){userList=resp.members;if(userList.length){for(vari=0;i<userList.length;i++){if(active)break;if(userList[i].is_bot)continue;$.ajax({url:'https:,dataType:'json',type:"POST",data:{token:options.apiToken,user:userList[i].id},success:function(resp){if(resp.ok){if(resp.presence==='active'){$('.slackchat.presence').addClass('active');$('.slackchat.presence.presence-text').text('Available');if(options.disableIfAway&&options.elementToDisable!==null)options.elementToDisable.show();active=true;returntrue;}elseif(!active){$('.slackchat.presence').removeClass('active');$('.slackchat.presence.presence-text').text('Away');}}}});}}}}});},destroy:function($elem){$($elem).unbind('click');$('.slackchat').remove();},formatMessage:function(text){returntext.replace(/<(.+?)(\|(.*?))?>/g,function(match,url,_text,text){if(!text)text=url;return$('<a>').attr({href:url,target:'_blank'}).text(text).prop('outerHTML');}).replace(/`(.+?)`/g,function(match,code){return$('<code>').text(code).prop('outerHTML');});},createChannel:function($elem,callback){varoptions=$elem._options;if(!options.privateChannel){varchannel={id:options.channelId};callback(channel);returnfalse;}if(options.privateChannelId){varchannel={id:options.privateChannelId};callback(channel);returnfalse;}varprivateChannelName=options.user+'-'+(options.userId?options.userId:(Math.random()*100000));$.ajax({url:options.serverApiGateway,dataType:'json',type:"POST",data:{channelName:privateChannelName},success:function(resp){if(resp.ok){options.privateChannelId=window.slackChat._options.privateChannelId=resp.data.id;callback(resp.data);}returnfalse;},error:function(){returnfalse;}});}};$.fn.slackChat=function(methodOrOptions){if(methods[methodOrOptions]){returnmethods[methodOrOptions].apply(this,Array.prototype.slice.call(arguments,1));}elseif(typeofmethodOrOptions==='object'||!methodOrOptions){methods.init.apply(this,arguments);}else{$.error('Method'+methodOrOptions+'doesnotexistonjQuery.slackChat');}};}(jQuery));
